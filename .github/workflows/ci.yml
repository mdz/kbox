name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  merge_group:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install GStreamer
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            python3-gi \
            python3-gst-1.0 \
            gir1.2-gstreamer-1.0 \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good

      - name: Install dependencies
        run: |
          # Create venv with system-site-packages to access apt-installed GStreamer
          uv venv --system-site-packages
          uv sync
          # Fix: uv sync may reset system-site-packages flag
          sed -i 's/include-system-site-packages = false/include-system-site-packages = true/' .venv/pyvenv.cfg

      - name: Lint with ruff
        run: uv run ruff check .

      - name: Check formatting with ruff
        run: uv run ruff format --check .

      - name: Type check with mypy
        run: uv run mypy kbox

      - name: Run tests
        run: uv run pytest -v

