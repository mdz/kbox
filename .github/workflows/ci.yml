name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  merge_group:

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: debian:stable-slim

    steps:
      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            git \
            ca-certificates \
            curl \
            python3 \
            python3-gi \
            python3-gst-1.0 \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good

      - uses: actions/checkout@v4

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          # Create venv with system-site-packages to access apt-installed GStreamer
          uv venv --system-site-packages
          uv sync
          # Fix: uv sync may reset system-site-packages flag
          sed -i 's/include-system-site-packages = false/include-system-site-packages = true/' .venv/pyvenv.cfg

      - name: Lint with ruff
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          uv run ruff check .

      - name: Check formatting with ruff
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          uv run ruff format --check .

      - name: Type check with mypy
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          uv run mypy kbox

      - name: Run tests
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          uv run pytest -v

