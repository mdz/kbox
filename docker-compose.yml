services:
  kbox:
    build: .
    devices:
      - "/dev/snd:/dev/snd"
      - "/dev/dri:/dev/dri"  # For KMS video
    ports:
      - "8000:8000"
    volumes:
      - kbox-data:/root/.kbox  # Persist database and config
      - kbox-cache:/root/.kbox/cache  # Persist downloads
    restart: unless-stopped

  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - kbox
    restart: unless-stopped

volumes:
  kbox-cache:
  kbox-data:
